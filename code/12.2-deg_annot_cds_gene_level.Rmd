---
title: "12-deg_annot_from_hisat"
author: "Megan Ewing"
date: "2024-05-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# do once
# install.packages("R.utils")
library(tidyverse)
library(R.utils)
library(dplyr)

```

# Gene level with deseq2 pre filtering (10+reads avg of 3+samples)

## Annotating our top DEGs using Blast and Uniprot Gene Ontology (GO) ids

Read in DEG count and stats files

```{r}
# for all counts: ../output/0807-logcounts_allDEG_8ind23r_ToC.csv
# for DEG stats: ../output/0807-DEGstats_ToC_8ind23r.tab

#read in count results
counts <- read.csv("../output/0807-logcounts_allDEG_8ind23r_ToC.csv", row.names = 1)
head(counts)

# add in stats
stats <- read.csv("../output/0807-DEGstats_ToC_8ind23r.tab", sep="")
head(stats)

```

Prep to join them (could be skipped by using the join_by( a == b), but I already wrote this chunk so..

```{r}
# make column with LOC names

LOCnames <- rownames(counts)

counts$LOC <- LOCnames

head(counts)

LOCstat <- rownames(stats)

stats$LOC <- LOCstat

head(stats)

```

Join them

```{r}
# joining stats and counts
DEG <- left_join(x = counts, y = stats, by = "LOC")
head(DEG)

```

Read in [annotated genome file](https://www.ncbi.nlm.nih.gov/datasets/gene/GCF_026571515.1/). Its named blast here because originally it was a blast file, but I didn't want to go and edit all the following chunks

```{r}
# read in annotationg
blast <- read.delim("../data/ncbi_dataset.tsv")
head(blast)
```

Joining annotation file to list of DEGs

```{r}
# join by gene name

DEG_Blast <- left_join(x = DEG, y = blast, join_by("LOC" == "Symbol"))
head(DEG_Blast)

# there's multiple entries for each LOC because of different isoforms, but we want just the gene level, so we are going to remove duplicates

DEG_Blast <- distinct(DEG_Blast, LOC, .keep_all = TRUE)
head(DEG_Blast)

# write_delim(DEG_Blast, "../output/0826-DEG_blast_cds_full.tab")

```

the following chunk is me seeing if I could pull the SPID from the full blast output and add it to my annot DEG list. 12 SPID short after join.. not sure why

```{r}

# read in blast full results
blastfull <- read.csv("../output/0821-rphil_blast_cds.tab", sep="")

# select for just the protein id and the saccver / spid info 
blastselect <- data.frame(protein = blastfull$protein_id, id = blastfull$saccver)

# join to the deg blast list by matching the protein ids
blastselect_deg <- left_join(DEG_Blast, blastselect, join_by("Protein.accession" == "protein") )

# removing any duplicate LOC entries that were created during the join
blast_id_deg <- distinct(blastselect_deg, LOC, .keep_all = TRUE)

```

### following code chunks ignored currently (as of 8/27/25)

### if using blast instead of annotated genome file : 

```{r}
# make a short file of just the DEG names and other desired data

DEG_annot <- data.frame( LOC = DEG_Blast$LOC, geneName = DEG_Blast$SPID, baseMean = DEG_Blast$baseMean, log2FoldChange = DEG_Blast$log2FoldChange, pvalue = DEG_Blast$pvalue, padj = DEG_Blast$padj, protein = DEG_Blast$protein, cds = DEG_Blast$cds  )

head(DEG_annot)


```

retrieving uniprot IDs

```{r}
# retrieve gene names for uniprot id lookup

# this is to get just the numbers from the geneName column for uniprot
# so sp|S8FGV1|LAC... becomes just S8FGV1
uniprot_id <-DEG_annot$geneName[!is.na(DEG_annot$geneName)]
head(uniprot_id)

# write to table for uniprot import (or could just copy and paste but i imported a text file to uniprot just for my own santity to make sure everything was included)
write.table(uniprot_id, "../output/0821-uniprot_id_cds_genelevel_8ind23r_ToC.txt", sep = "\t", row.names = FALSE, col.names = FALSE, quote = FALSE)

# and now for all the uniprot ids at the gene level that blast had
write.table(blast$SPID, "../output/0821-uniprot_id_cds_genelevel_8ind23r_ToC.txt", sep = "\t", row.names = FALSE, col.names = FALSE, quote = FALSE)

```

GO annotations

```{r}

# retrieved our unirpot id GO file from the web interface https://www.uniprot.org/
# importing and unzipping file here

gunzip("../data/idmapping_2024_05_14.tsv.gz")

GO_id <- read.csv("../data/idmapping_2024_05_14.tsv", sep = '\t', header = TRUE, row.names=NULL)
head(GO_id)
```

```{r}
# join GO id info to our DEG_annot dataframe from earlier by the uniprot ids

clam_GO_annotations <- merge(DEG_annot, GO_id, by.x = "uniprot_id", by.y = "Entry")
head(clam_GO_annotations)

```

```{r}
# siic it looks all good so let's write to file

write.csv(clam_GO_annotations, "../output/clam_GO_annotations_cds_0514.csv")
```
